name: Auto Label After Analysis
on:
  issue_comment:
    types: [created]

jobs:
  add-label-after-analysis:
    # Claude[bot]のコメントで、working...メッセージではない場合
    if: |
      github.event.comment.user.login == 'claude[bot]' &&
      !contains(github.event.comment.body, 'Claude Code is working')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Debug Info
        run: |
          echo "Claude comment detected!"
          echo "Comment preview: ${COMMENT_BODY:0:100}..."
          echo "Contains ANALYSIS_COMPLETE: ${{ contains(github.event.comment.body, '[ANALYSIS_COMPLETE]') }}"
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}

      - name: Check and Add Label
        if: contains(github.event.comment.body, '[ANALYSIS_COMPLETE]')
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ANALYSIS_COMPLETE marker found! Adding label...');
            
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['workflow:ready-for-impl']
              });
              
              console.log('Successfully added workflow:ready-for-impl label');
            } catch (error) {
              console.error('Failed to add label:', error);
              throw error;
            }
