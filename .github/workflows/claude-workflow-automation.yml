name: Claude Marker-Based Handler

on:
  issue_comment:
    types: [created]

jobs:
  # ãƒãƒ¼ã‚«ãƒ¼ãƒ™ãƒ¼ã‚¹ã®æ¤œçŸ¥ï¼ˆæœ€ã‚‚ç¢ºå®Ÿï¼‰
  handle-claude-with-markers:
    if: github.event.comment.user.login == 'claude[bot]'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
      pull-requests: write
    
    steps:
      - name: Check for markers
        id: check_markers
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          # ç‰¹å®šã®ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¤œç´¢
          if echo "$COMMENT_BODY" | grep -q "<!-- ANALYSIS_COMPLETE -->"; then
            echo "action=trigger_implementation" >> $GITHUB_OUTPUT
          elif echo "$COMMENT_BODY" | grep -q "<!-- IMPLEMENTATION_COMPLETE -->"; then
            echo "action=trigger_review" >> $GITHUB_OUTPUT
          else
            echo "action=none" >> $GITHUB_OUTPUT
          fi
      
      - name: Trigger implementation
        if: steps.check_markers.outputs.action == 'trigger_implementation'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "âœ… Analysis complete marker detected"
          
          # ãƒ©ãƒ™ãƒ«è¿½åŠ ã¨å®Ÿè£…ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
          gh issue edit ${{ github.event.issue.number }} --add-label "workflow:active"
          
          sleep 10
          
          cat << 'EOF' > comment.txt
          @claude PRã‚’ä½œæˆã—ã¦å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚
          
          å®Ÿè£…ãŒå®Œäº†ã—ãŸã‚‰ã€ã‚³ãƒ¡ãƒ³ãƒˆã®æœ€å¾Œã«ä»¥ä¸‹ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å«ã‚ã¦ãã ã•ã„ï¼š
          <!-- IMPLEMENTATION_COMPLETE -->
          EOF
          
          gh issue comment ${{ github.event.issue.number }} --body-file comment.txt
      
      - name: Trigger review
        if: steps.check_markers.outputs.action == 'trigger_review'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "âœ… Implementation complete marker detected"
          
          gh issue edit ${{ github.event.issue.number }} --add-label "workflow:ready-for-review"
          gh issue comment ${{ github.event.issue.number }} \
            --body "ğŸ‰ å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸï¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æº–å‚™ãŒã§ãã¦ã„ã¾ã™ã€‚"
