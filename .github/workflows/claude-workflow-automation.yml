name: Claude Marker-Based Handler

on:
  issue_comment:
    types: [created]

jobs:
  # マーカーベースの検知（最も確実）
  handle-claude-with-markers:
    if: github.event.comment.user.login == 'claude[bot]'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
      pull-requests: write
    
    steps:
      - name: Check for markers
        id: check_markers
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          # 特定のマーカーを検索
          if echo "$COMMENT_BODY" | grep -q "<!-- ANALYSIS_COMPLETE -->"; then
            echo "action=trigger_implementation" >> $GITHUB_OUTPUT
          elif echo "$COMMENT_BODY" | grep -q "<!-- IMPLEMENTATION_COMPLETE -->"; then
            echo "action=trigger_review" >> $GITHUB_OUTPUT
          else
            echo "action=none" >> $GITHUB_OUTPUT
          fi
      
      - name: Trigger implementation
        if: steps.check_markers.outputs.action == 'trigger_implementation'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "✅ Analysis complete marker detected"
          
          # ラベル追加と実装リクエスト
          gh issue edit ${{ github.event.issue.number }} --add-label "workflow:active"
          
          sleep 10
          
          cat << 'EOF' > comment.txt
          @claude PRを作成して実装してください。
          
          実装が完了したら、コメントの最後に以下のマーカーを含めてください：
          <!-- IMPLEMENTATION_COMPLETE -->
          EOF
          
          gh issue comment ${{ github.event.issue.number }} --body-file comment.txt
      
      - name: Trigger review
        if: steps.check_markers.outputs.action == 'trigger_review'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "✅ Implementation complete marker detected"
          
          gh issue edit ${{ github.event.issue.number }} --add-label "workflow:ready-for-review"
          gh issue comment ${{ github.event.issue.number }} \
            --body "🎉 実装が完了しました！レビューの準備ができています。"
