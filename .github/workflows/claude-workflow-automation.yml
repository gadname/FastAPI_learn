name: Claude Analysis Completion Handler

on:
  issue_comment:
    types: [created]

jobs:
  # Claudeã®åˆ†æå®Œäº†ã‚’æ¤œçŸ¥ã—ã¦å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚ºã‚’é–‹å§‹
  handle-claude-analysis:
    if: |
      github.event.comment.user.login == 'claude[bot]' &&
      (
        contains(github.event.comment.body, 'Comprehensive Execution Plan') ||
        contains(github.event.comment.body, 'Analysis complete') ||
        contains(github.event.comment.body, 'Estimated Timeline') ||
        contains(github.event.comment.body, 'Implementation Strategy') ||
        contains(github.event.comment.body, 'åˆ†æå®Œäº†')
      )
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Log detection
        run: |
          echo "âœ… Claude's analysis completion detected!"
          echo "Issue: #${{ github.event.issue.number }}"
          echo "Comment by: ${{ github.event.comment.user.login }}"
      
      - name: Add workflow label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # GitHub CLIã§ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ï¼ˆäººé–“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ï¼‰
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "workflow:active" || echo "Label might already exist"
      
      - name: Wait before triggering implementation
        run: |
          echo "â³ Waiting 10 seconds before triggering implementation..."
          sleep 10
      
      - name: Trigger implementation phase
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å®Ÿè£…ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
          COMMENT_BODY="@claude PRã‚’ä½œæˆã—ã¦å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚å®Ÿè£…å¾Œã€å®Ÿè£…å®Œäº†ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚

å®Ÿè£…ãŒå®Œäº†ã—ãŸã‚‰ã€ä»¥ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å«ã‚€ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¦ãã ã•ã„ï¼š
\`Implementation complete\` ã¾ãŸã¯ \`å®Ÿè£…å®Œäº†\`"
          
          gh issue comment ${{ github.event.issue.number }} \
            --body "$COMMENT_BODY"
          
          echo "âœ… Implementation request posted!"

  # Claudeã®å®Ÿè£…å®Œäº†ã‚’æ¤œçŸ¥
  handle-implementation-complete:
    if: |
      github.event.comment.user.login == 'claude[bot]' &&
      (
        contains(github.event.comment.body, 'Implementation complete') ||
        contains(github.event.comment.body, 'å®Ÿè£…å®Œäº†') ||
        contains(github.event.comment.body, 'PR created') ||
        contains(github.event.comment.body, 'Pull request created')
      )
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    
    steps:
      - name: Log implementation completion
        run: |
          echo "âœ… Claude's implementation completion detected!"
          echo "Issue: #${{ github.event.issue.number }}"
      
      - name: Add review label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "workflow:ready-for-review" || echo "Label might already exist"
      
      - name: Post review notification
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body "ğŸ‰ å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸï¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æº–å‚™ãŒã§ãã¦ã„ã¾ã™ã€‚"
